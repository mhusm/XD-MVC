<!DOCTYPE html>
<html>
    <head>
       <!-- 1. Load platform support before any code that touches the DOM. -->
        <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
        <link rel="import" href="bower_components/polymer/polymer.html">
        <!-- 2. Load the component using an HTML Import -->
        <script src="bower_components/xdmvcclient/js/queryParams.js"></script>

        <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-synchronised.html">
        <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-connection.html">
        <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-roles.html">
        <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-devices.html">
        <link rel="import" href="elements/image-element.html">
        <link rel="import" href="elements/gallery-element.html">

        <meta name="viewport" content="width=device-width, user-scalable=no">

    </head>
    <body>
        <dom-module id="my-app">
            <template>
                <xdmvc-connection peerport="9005" ajaxport="9006"></xdmvc-connection>
                <xdmvc-synchronised id="sync"
                                    objects='{{synced}}'>
                </xdmvc-synchronised>
                <xdmvc-roles id="roles"
                             available='["owner", "visitor"]'
                             roles="{{roles}}">
                </xdmvc-roles>
                <xdmvc-devices id="devices" devices="{{devices}}"></xdmvc-devices>


                 <template is="dom-if" if="{{roles.isselected.owner}}">
                    <h1>Share your photos!</h1>
                    <input is="core-input" type="file" multiple accept="image/*" on-change="handleFiles"  label="Choose photos"/>
                    <gallery-element id='gallery'
                                     images="{{synced.images}}"
                                     current="{{synced.current.index}}">
                    </gallery-element>
                </template>
                <template is="dom-if" if="{{showImage}}">
                    <image-element id="image" images="{{synced.images}}"
                                   current="{{synced.current.index}}"
                                   cursor="{{synced.cursor}}"
                                   show-controls="{{roles.isselected.owner}}"></image-element>
                </template>

            </template>


        </dom-module>
        <script>
            HTMLImports.whenReady(function () {

                Polymer({
                    is: "my-app",

                    properties: {
                        synced: {
                            type: Object,
                            value: function(){ return {"current": { "index":0}, "images": [],
                                "cursor" :{"x": -1, "y": -1}} } ,
                            notify: true
                        },
                        showImage: {
                            type: Boolean,
                            value: false,
                            notify: true
                        }
                    },

                    _computeShowImage: function() {
                        this.showImage = !(this.roles.isselected.owner && this.devices.othersDevices.large > 0);
                    },

                    observers: [
                        '_computeShowImage(roles.*, devices.othersDevices.*, synced.images.*)'
                    ],


                    handleFiles: function (event) {
                        var files = event.target.files;
                        for (var i = 0; i < files.length; i++) {
                            var file = files[i];
                            var imageType = /image.*/;

                            if (!file.type.match(imageType)) {
                                continue;
                            }

                            var imgData = this.$.sync.objects.images;
                            var reader = new FileReader();
                            reader.onload = function(e) {
                                 this.push("synced.images", e.target.result);
                            }.bind(this);
                            reader.readAsDataURL(file);
                         }
                    },

                    ready: function() {
                        if (XDmvc.XDd2d.serverReady) {
                            this.onServerReady();
                        } else { // not yet connected to server, wait for the connection event
                            XDmvc.XDd2d.on("XDserverReady", this.onServerReady.bind(this));
                        }
                    },
                    onServerReady: function(){
                        var connect = getQueryParams(window.location.search).connect;
                        if (!connect){
                            var connectString = 'connect='+XDmvc.deviceId;
                            window.history.pushState('', '', window.location.search.length > 0? window.location.search +"&" +connectString : '?'+connectString);
                            this.$.roles.addRole('owner');
                        } else {
                            if (connect !== XDmvc.deviceId) {
                                XDmvc.connectTo(connect);
                                this.$.roles.addRole('visitor');
                            } else {
                                this.$.roles.addRole('owner');
                            }
                        }
                    }


                });
            });
        </script>

        <my-app></my-app>

    </body>
</html>